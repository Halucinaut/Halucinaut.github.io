{{ define "main" }}

{{ $isSubProject := .Params.parent_project }}
<article class="post-single{{ if $isSubProject }} sub-project-page{{ end }}">
  <header class="post-header">
    {{ partial "breadcrumbs.html" . }}
    <h1 class="post-title">{{ .Title }}</h1>
    {{ if .Description }}
    <div class="post-description">{{ .Description }}</div>
    {{ end }}
    {{ if not (.Param "hidemeta") }}
    <!-- éšè—å…ƒä¿¡æ¯ï¼ˆé˜…è¯»æ—¶é—´ã€ä½œè€…ç­‰ï¼‰ -->
    {{ end }}
  </header>

  {{ if .Params.cover.image }}
  <figure class="entry-cover">
    <img loading="lazy" src="{{ .Params.cover.image | absURL }}" alt="{{ .Params.cover.alt }}" />
  </figure>
  {{ end }}

  <div class="post-content">
    {{ .Content }}
  </div>

  <!-- å­é¡¹ç›®å±•ç¤ºåŒºåŸŸ -->
  {{ $currentTitle := .Title }}
  {{ $subProjects := where .Site.RegularPages "Params.parent_project" $currentTitle }}
  {{ if $subProjects }}
  <section class="sub-projects">
    <h2>â­ Featured Skills</h2>
    <div class="projects-grid">
      {{ range $subProjects }}
      <article class="project-card sub-project-card">
        {{ if .Params.cover.image }}
        <a href="{{ .RelPermalink }}" class="card-link">
          <figure class="entry-cover">
            <img loading="lazy" src="{{ .Params.cover.image | absURL }}" alt="{{ .Params.cover.alt }}" />
          </figure>
        </a>
        {{ end }}
        <div class="card-content">
          <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
          {{ if .Summary }}
          <p class="card-summary">{{ .Summary }}</p>
          {{ end }}
          {{ if .Params.tags }}
          <div class="card-tags">
            {{ range .Params.tags }}
            <span class="tag">{{ . }}</span>
            {{ end }}
          </div>
          {{ end }}
          <div class="card-footer">
            <span class="giscus-reactions" data-path="{{ .RelPermalink }}">ğŸ‘ 0</span>
          </div>
        </div>
      </article>
      {{ end }}
    </div>
  </section>
  {{ end }}

  <!-- é¡¹ç›®æŒ‰é’® -->
  <div class="project-buttons">
    {{ if .Params.demo_url }}
    <a class="button-demo" href="{{ .Params.demo_url }}" target="_blank" rel="noopener">ğŸš€ Live Demo</a>
    {{ end }}
    {{ if .Params.repo_url }}
    <a class="button-repo" href="{{ .Params.repo_url }}" target="_blank" rel="noopener">ğŸ’» Source Code</a>
    {{ end }}
  </div>

  <footer class="post-footer">
    {{ if .Params.tags }}
    <ul class="post-tags">
      {{ range .Params.tags }}
      <li><a href="{{ "/tags/" | absURL }}{{ . | urlize }}">{{ . }}</a></li>
      {{ end }}
    </ul>
    {{ end }}
  </footer>

  <!-- é¡¹ç›®é¡µé¢æ˜¾ç¤ºè¯„è®ºåŒº -->
  {{ partial "comments.html" . }}
</article>

<script>
// æ£€æµ‹å­é¡¹ç›®å¡ç‰‡æ ‡é¢˜æ˜¯å¦è¶…å‡ºå®¹å™¨å®½åº¦
document.addEventListener('DOMContentLoaded', function() {
    const titles = document.querySelectorAll('.sub-project-card h3');
    titles.forEach(function(title) {
        const container = title.parentElement;
        if (title.scrollWidth > container.clientWidth) {
            title.setAttribute('data-overflow', 'true');
        }
    });
});

// ä» Giscus è·å–å­é¡¹ç›®ååº”æ•°ï¼ˆå¤ç”¨çˆ¶é¡µé¢çš„å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨ï¼‰
if (typeof fetchGiscusReactions !== 'function') {
    async function fetchGiscusReactions() {
        const repo = 'Halucinaut/Halucinaut.github.io';
        const reactionElements = document.querySelectorAll('.giscus-reactions');
        
        if (reactionElements.length === 0) return;
        
        try {
            const response = await fetch(`https://api.github.com/repos/${repo}/discussions?per_page=100`);
            if (!response.ok) throw new Error('Failed to fetch discussions');
            
            const discussions = await response.json();
            
            reactionElements.forEach(function(el) {
                const path = el.getAttribute('data-path');
                const discussion = discussions.find(function(d) {
                    return d.body && d.body.includes(path);
                });
                
                if (discussion && discussion.reactions) {
                    const total = discussion.reactions.total_count;
                    if (total > 0) {
                        el.textContent = 'ğŸ‘ ' + total;
                    }
                }
            });
        } catch (error) {
            console.log('Giscus reactions fetch failed:', error);
        }
    }
    
    fetchGiscusReactions();
}
</script>
{{ end }}
